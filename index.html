<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sofitel Cleaning Project Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar for better aesthetics in dark mode */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <!-- Header Section -->
        <header class="mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-white mb-2">Sofitel Post-Construction Cleaning Dashboard</h1>
            <p class="text-lg text-gray-400">An analysis of room entries and work scope for Level 6.</p>
        </header>

        <main class="space-y-8">
            
            <!-- Key Metrics Section -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700">
                    <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wider">Total Rooms Tracked</h3>
                    <p id="totalRooms" class="text-3xl font-semibold text-white mt-2">0</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700">
                    <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wider">Total Room Entries</h3>
                    <p id="totalEntries" class="text-3xl font-semibold text-white mt-2">0</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700">
                    <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wider">Avg. Visits Per Room</h3>
                    <p id="avgVisits" class="text-3xl font-semibold text-white mt-2">0.0</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700">
                    <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wider">Most Visited Room</h3>
                    <p id="mostVisited" class="text-3xl font-semibold text-white mt-2">-</p>
                </div>
            </div>

            <!-- Workflow Analysis Section -->
            <div class="bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-lg border border-gray-700">
                <div class="mb-6 text-center">
                    <h2 class="text-2xl font-bold text-white">Workflow Analysis: Programme vs. On-Site Reality</h2>
                    <p class="text-gray-400 mt-1 max-w-3xl mx-auto">Illustrating the difference between the planned, linear process and the actual, dynamic work environment.</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
                    
                    <!-- The Ideal Workflow -->
                    <div class="bg-gray-900/50 p-6 rounded-lg border border-gray-700 h-full">
                        <h3 class="text-xl font-semibold text-white mb-6 text-center">The Programme: A Linear Workflow</h3>
                        <div class="relative pl-8">
                            <!-- Timeline Line -->
                            <div class="absolute left-4 top-2 bottom-2 w-0.5 bg-gray-600"></div>
                            
                            <!-- Step 1 -->
                            <div class="relative mb-12">
                                <div class="absolute left-[-2rem] top-1.5 w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white font-bold ring-4 ring-gray-800">1</div>
                                <h4 class="font-semibold text-green-400">Construction Phase Complete</h4>
                                <p class="text-sm text-gray-400 mt-1">Trades finish joinery, electrical, painting, carpet.</p>
                            </div>
                            <!-- Step 2 -->
                            <div class="relative mb-12">
                                <div class="absolute left-[-2rem] top-1.5 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold ring-4 ring-gray-800">2</div>
                                <h4 class="font-semibold text-blue-400">Visit 1: Initial Builders Clean</h4>
                                <p class="text-sm text-gray-400 mt-1">Deep clean in an empty, uninterrupted room.</p>
                            </div>
                            <!-- Step 3 -->
                            <div class="relative mb-12">
                                <div class="absolute left-[-2rem] top-1.5 w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white font-bold ring-4 ring-gray-800">3</div>
                                <h4 class="font-semibold text-green-400">Finishing Phase Complete</h4>
                                <p class="text-sm text-gray-400 mt-1">Final trades finish furniture, curtains, caulking.</p>
                            </div>
                            <!-- Step 4 -->
                            <div class="relative">
                                <div class="absolute left-[-2rem] top-1.5 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold ring-4 ring-gray-800">4</div>
                                <h4 class="font-semibold text-blue-400">Visit 2: Final Clean</h4>
                                <p class="text-sm text-gray-400 mt-1">Final touch-up for handover in a completed room.</p>
                            </div>
                        </div>
                    </div>

                    <!-- The Actual Workflow -->
                    <div class="bg-gray-900/50 p-6 rounded-lg border border-gray-700 h-full">
                        <h3 class="text-xl font-semibold text-white mb-6 text-center">The Reality: A Cyclical Workflow</h3>
                        <div class="relative pl-8">
                            <!-- Timeline Line -->
                            <div class="absolute left-4 top-2 bottom-2 w-0.5 bg-gray-600"></div>
                            
                            <!-- Step 1 -->
                            <div class="relative mb-4">
                                <div class="absolute left-[-2rem] top-1.5 w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold ring-4 ring-gray-800">1</div>
                                <h4 class="font-semibold text-blue-400">Visit 1: "Heavy Dirt" Clean</h4>
                                <p class="text-sm text-gray-400 mt-1">Initial clean performed while some trades are still active.</p>
                                 <blockquote class="mt-2 pl-3 border-l-2 border-gray-600 text-xs italic text-gray-500">
                                    "I understand there's going to be people going into them again... but at least the heavy dirt is done."
                                    <cite class="block not-italic mt-1">- Jerry, Sept 4</cite>
                                </blockquote>
                            </div>
                             <!-- Step 2 -->
                            <div class="relative mb-4">
                                <div class="absolute left-[-2rem] top-1.5 w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center text-white font-bold ring-4 ring-gray-800">2</div>
                                <h4 class="font-semibold text-yellow-400">Ongoing Trades Activity</h4>
                                <p class="text-sm text-gray-400 mt-1">Joinery, shelves, and other fixtures installed after initial clean.</p>
                                <blockquote class="mt-2 pl-3 border-l-2 border-gray-600 text-xs italic text-gray-500">
                                    "It is hard at the moment because I mean there are fellas still working and it just makes it hard for you guys as well."
                                    <cite class="block not-italic mt-1">- Jerry, Sept 9</cite>
                                </blockquote>
                            </div>
                             <!-- Step 3 -->
                            <div class="relative mb-4">
                                <div class="absolute left-[-2rem] top-1.5 w-8 h-8 bg-red-500 rounded-full flex items-center justify-center text-white font-bold ring-4 ring-gray-800">3</div>
                                <h4 class="font-semibold text-red-400">Visit 2: "Proper" Clean-Through</h4>
                                <p class="text-sm text-gray-400 mt-1">Client requests a re-clean of joinery and shelves.</p>
                                <blockquote class="mt-2 pl-3 border-l-2 border-gray-600 text-xs italic text-gray-500">
                                    "I need to do a proper kind of a clean through the whole lot of them... there's still some of the joinery hasn't been cleaned."
                                    <cite class="block not-italic mt-1">- Jerry, Sept 8</cite>
                                </blockquote>
                            </div>
                            <!-- Step 4 -->
                            <div class="relative mb-4">
                                <div class="absolute left-[-2rem] top-1.5 w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center text-white font-bold ring-4 ring-gray-800">4</div>
                                <h4 class="font-semibold text-yellow-400">Final Finishes & Furnishing</h4>
                                <p class="text-sm text-gray-400 mt-1">Painters, electricians, and decorators enter cleaned rooms.</p>
                                 <blockquote class="mt-2 pl-3 border-l-2 border-gray-600 text-xs italic text-gray-500">
                                    "Today people were hanging pictures... using machines, filling with dust again... putting silicone in already clean bathrooms."
                                    <cite class="block not-italic mt-1">- Aisha, Sept 16</cite>
                                </blockquote>
                            </div>
                            <!-- Step 5 -->
                            <div class="relative">
                                <div class="absolute left-[-2rem] top-1.5 w-8 h-8 bg-red-500 rounded-full flex items-center justify-center text-white font-bold ring-4 ring-gray-800">3+</div>
                                <h4 class="font-semibold text-red-400">Visits 3, 4, 5...: The Final Touches</h4>
                                <p class="text-sm text-gray-400 mt-1">Multiple additional visits requested for final touch-ups.</p>
                                <blockquote class="mt-2 pl-3 border-l-2 border-gray-600 text-xs italic text-gray-500">
                                    "Listen, can I get three of the girls back again tomorrow for a little bit?"
                                    <cite class="block not-italic mt-1">- Jerry, Sept 16</cite>
                                </blockquote>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Client Feedback & Sentiment Section -->
            <div class="bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-lg border border-gray-700">
                <div class="flex items-center mb-4">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 text-green-400 mr-3"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>
                    <div>
                        <h2 class="text-2xl font-bold text-white">Client Feedback & Sentiment</h2>
                         <p class="text-gray-400">Quality of work remained consistently high despite challenging conditions.</p>
                    </div>
                </div>
                <div class="space-y-3">
                    <div class="bg-gray-900/50 p-3 rounded-lg border border-gray-700">
                        <p class="text-sm italic text-gray-300">"Yeah, yeah, very good... As long as it's done good, I don't mind. So yeah, it was the quality was good... the rooms look really good."</p>
                        <p class="text-right text-xs text-gray-500 mt-1">- Jerry, Sept 4</p>
                    </div>
                     <div class="bg-gray-900/50 p-3 rounded-lg border border-gray-700">
                        <p class="text-sm italic text-gray-300">"Nah, they did a great job, man. So, that's good."</p>
                        <p class="text-right text-xs text-gray-500 mt-1">- Jerry, Sept 16</p>
                    </div>
                </div>
            </div>


            <!-- Chart Section -->
            <div class="bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-lg border border-gray-700">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                    <div>
                        <h2 id="chartTitle" class="text-2xl font-bold text-white">Visits Per Room</h2>
                        <p id="chartSubtitle" class="text-gray-400 mt-1">Shows how many times each room was entered for cleaning tasks.</p>
                    </div>
                    <div class="mt-4 sm:mt-0">
                        <label for="viewSelector" class="sr-only">Select View</label>
                        <select id="viewSelector" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                            <option value="perRoom" selected>Visits Per Room</option>
                            <option value="byReason">Entries by Reason</option>
                            <option value="timeline">Timeline of Entries</option>
                        </select>
                    </div>
                </div>
                
                <div class="relative h-96 w-full">
                    <canvas id="cleaningChart"></canvas>
                </div>
            </div>

            <!-- Table Section -->
            <div class="bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-lg border border-gray-700">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-white">Room Visit Summary</h2>
                    <p class="text-gray-400 mt-1">A summary showing all visit dates for each room.</p>
                </div>
                <div class="overflow-x-auto max-h-96">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-700/50 sticky top-0">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Room</th>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Total Visits</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Dates of Entry</th>
                            </tr>
                        </thead>
                        <tbody id="logTableBody" class="bg-gray-800 divide-y divide-gray-700">
                            <!-- Rows will be populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Client Requests Timeline Section -->
            <div class="bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-lg border border-gray-700">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-white">Timeline of Client Requests & Scope Changes</h2>
                    <p class="text-gray-400 mt-1">Key communications that led to additional work beyond the initial scope.</p>
                </div>
                <div id="timelineContainer" class="space-y-6">
                    <!-- Timeline items will be populated by JS -->
                </div>
            </div>
            
            <!-- Project Summary & Solution Section -->
            <div class="bg-gray-800 p-4 sm:p-6 rounded-2xl shadow-lg border border-gray-700">
                <div class="mb-6 text-center">
                    <h2 class="text-2xl font-bold text-white">Project Summary & Proposed Solution</h2>
                    <p class="text-gray-400 mt-1 max-w-3xl mx-auto">Analyzing the budget variance for Level 6 and proposing a collaborative path forward.</p>
                </div>

                <!-- Budget vs Actual Cards -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gray-700 p-5 rounded-xl">
                        <h3 class="text-sm font-medium text-gray-400">Budgeted Hours (Level 6)</h3>
                        <p class="text-3xl font-semibold text-white mt-1">105</p>
                    </div>
                    <div class="bg-gray-700 p-5 rounded-xl">
                        <h3 class="text-sm font-medium text-gray-400">Actual Hours to Date</h3>
                        <p class="text-3xl font-semibold text-white mt-1">119</p>
                    </div>
                    <div class="bg-gray-700 p-5 rounded-xl">
                        <h3 class="text-sm font-medium text-gray-400">Forecasted Total Hours</h3>
                        <p class="text-3xl font-semibold text-white mt-1">~140</p>
                    </div>
                    <div class="bg-red-900/50 border border-red-700 p-5 rounded-xl">
                        <h3 class="text-sm font-medium text-red-300">Projected Variance</h3>
                        <p class="text-3xl font-semibold text-red-300 mt-1">+33%</p>
                    </div>
                </div>

                <!-- Analysis & Solution Text -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                    <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                        <h4 class="font-semibold text-lg text-white mb-2">Analysis</h4>
                        <ul class="space-y-2 text-gray-300 list-disc list-inside">
                            <li>The initial budget of <strong class="text-white">105 hours</strong> was accurately based on the agreed scope of two visits per room in an uninterrupted setting.</li>
                            <li>The project's reality involved a dynamic, cyclical workflow with ongoing trades, necessitating multiple re-entries as documented in this report.</li>
                            <li>This resulted in a projected <strong class="text-red-400">~33% increase in hours</strong>, reflecting our team's flexibility and commitment to achieving a high-quality finish despite the evolving conditions.</li>
                        </ul>
                    </div>
                    <div class="bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                         <h4 class="font-semibold text-lg text-white mb-2">Proposed Solution</h4>
                        <p class="text-gray-300 mb-3">We are committed to our partnership and delivering an excellent result. Our goal is to ensure fairness and maintain project momentum for the upcoming levels.</p>
                        <p class="text-gray-300"><strong class="text-white">For Level 6:</strong> We propose a collaborative review of the budget to account for the additional, client-directed work that exceeded the original scope.</p>
                        <p class="text-gray-300 mt-2"><strong class="text-white">For Future Levels:</strong> We suggest establishing a clear protocol for handling re-entry requests. This will ensure budget predictability and allow us to build on the efficiencies learned from Level 6 for an even smoother process.
                        </p>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // --- DATA ---
        // This data has been meticulously compiled from all provided chat logs.
        const cleaningData = [
            { date: "2025-09-04", room: "617", reason: "Initial Clean" },
            { date: "2025-09-04", room: "615", reason: "Initial Clean" },
            { date: "2025-09-04", room: "620", reason: "Initial Clean" },
            { date: "2025-09-04", room: "611", reason: "Initial Clean" },
            { date: "2025-09-05", room: "616", reason: "Initial Clean" },
            { date: "2025-09-05", room: "614", reason: "Initial Clean (Bathroom Pending)" },
            { date: "2025-09-05", room: "621", reason: "Initial Clean" },
            { date: "2025-09-05", room: "612", reason: "Initial Clean (Bathroom Pending)" },
            { date: "2025-09-08", room: "621", reason: "Client Request: Re-clean" },
            { date: "2025-09-08", room: "617", reason: "Client Request: Re-clean" },
            { date: "2025-09-08", room: "615", reason: "Client Request: Re-clean" },
            { date: "2025-09-08", room: "616", reason: "Client Request: Re-clean" },
            { date: "2025-09-08", room: "612", reason: "Client Request: Windows & Bathroom Completion" },
            { date: "2025-09-08", room: "614", reason: "Client Request: Windows & Bathroom Completion" },
            { date: "2025-09-08", room: "609", reason: "Initial Clean" },
            { date: "2025-09-08", room: "610", reason: "Initial Clean" },
            { date: "2025-09-09", room: "617", reason: "Client Request: Re-clean/Touch-up" },
            { date: "2025-09-09", room: "615", reason: "Client Request: Re-clean/Touch-up" },
            { date: "2025-09-09", room: "616", reason: "Client Request: Re-clean/Touch-up" },
            { date: "2025-09-09", room: "614", reason: "Client Request: Re-clean/Touch-up" },
            { date: "2025-09-09", room: "612", reason: "Client Request: Re-clean/Touch-up" },
            { date: "2025-09-09", room: "621", reason: "Client Request: Re-clean/Touch-up" },
            { date: "2025-09-09", room: "620", reason: "Client Request: Re-clean/Touch-up" },
            { date: "2025-09-09", room: "618", reason: "Initial Clean" },
            { date: "2025-09-15", room: "621", reason: "Final Clean / Prep (Bathroom Completion)" },
            { date: "2025-09-15", room: "617", reason: "Final Clean / Prep" },
            { date: "2025-09-16", room: "617", reason: "Final Clean" },
            { date: "2025-09-16", room: "615", reason: "Final Clean" },
            { date: "2025-09-16", room: "620", reason: "Final Clean" },
            { date: "2025-09-16", room: "611", reason: "Final Clean" },
            { date: "2025-09-16", room: "616", reason: "Final Clean" },
            { date: "2025-09-16", room: "614", reason: "Final Clean" },
            { date: "2025-09-16", room: "621", reason: "Final Clean" },
            { date: "2025-09-16", room: "612", reason: "Final Clean" },
            { date: "2025-09-16", room: "609", reason: "Final Clean" },
            { date: "2025-09-16", room: "610", reason: "Final Clean" },
            { date: "2025-09-16", room: "618", reason: "Final Clean" },
            { date: "2025-09-16", room: "619", reason: "Initial Clean" },
            { date: "2025-09-17", room: "609", reason: "Client Request: Post-Final Touch-up" },
            { date: "2025-09-17", room: "621", reason: "Client Request: Post-Final Touch-up" },
            { date: "2025-09-17", room: "620", reason: "Client Request: Post-Final Touch-up" }
        ];

        const timelineEvents = [
             {
                date: "September 8, 2025",
                title: "First Major Re-Clean Request",
                description: `Client requested a 'proper kind of a clean' through all previously serviced rooms to address joinery and shelves that were installed after our initial visit. <blockquote class="mt-2 pl-3 border-l-2 border-gray-600 text-xs italic text-gray-500">"I need to... do a proper kind of a clean through the whole lot of them. As in because there's still some of the joinery hasn't been cleaned, top of the shelves and stuff like that."</blockquote>`,
                impact: "This was the first direct request for a full re-clean of multiple rooms, establishing the pattern of a cyclical workflow."
            },
            {
                date: "September 9, 2025",
                title: "Acknowledgement of On-Site Challenges",
                description: `The client acknowledged the difficulty of cleaning while trades were still active, confirming the initial expectation of working in empty rooms was not being met. <blockquote class="mt-2 pl-3 border-l-2 border-gray-600 text-xs italic text-gray-500">"It is hard at the moment because I mean there are fellas still working and it just makes it hard for you guys as well."</blockquote>`,
                impact: "Verbal confirmation that the working conditions differed from the initial agreement, justifying the need for additional visits."
            },
            {
                date: "September 15, 2025",
                title: "Early Start on Final Cleans",
                description: "Client requested an early start on the final cleans, asking a cleaner to begin work on rooms that were officially scheduled for the following day.",
                impact: "Demonstrated the compressed and demanding timeline leading up to the final handover."
            },
            {
                date: "September 16, 2025",
                title: "Mid-Day Request for More Cleaners & Unplanned Day",
                description: `After a long day of concurrent work with other trades, the client requested that cleaners return for an additional day of touch-ups. <blockquote class="mt-2 pl-3 border-l-2 border-gray-600 text-xs italic text-gray-500">"Listen, can I get three of the girls back again tomorrow for a little bit?"</blockquote>`,
                impact: "Added another full, unplanned day of work to the schedule for multiple cleaners, leading to 4th and 5th visits to rooms."
            },
            {
                date: "September 17, 2025",
                title: "Final Touch-up Day",
                description: "Cleaners were on-site performing final touch-ups on multiple rooms (e.g., 609, 621, 620) as per the client's request from the previous day.",
                impact: "This constituted the 4th, 5th, or even 6th visit to several rooms, far exceeding the contracted two visits."
            }
        ];

        let myChart; // Global chart instance

        // --- DATA PROCESSING FUNCTIONS ---

        function getVisitsPerRoom() {
            const counts = cleaningData.reduce((acc, entry) => {
                acc[entry.room] = (acc[entry.room] || 0) + 1;
                return acc;
            }, {});
            const sorted = Object.entries(counts).sort((a, b) => a[0].localeCompare(b[0], undefined, {numeric: true}));
            return {
                labels: sorted.map(item => `Room ${item[0]}`),
                data: sorted.map(item => item[1])
            };
        }

        function getVisitsByReason() {
            const counts = cleaningData.reduce((acc, entry) => {
                // Simplify reason for better grouping
                let reason = entry.reason;
                if (reason.includes('Re-clean') || reason.includes('Touch-up')) {
                    reason = 'Client Request: Re-clean/Fix';
                } else if (reason.includes('Final')) {
                    reason = 'Final Clean / Prep';
                } else if (reason.includes('Initial')) {
                    reason = 'Initial Clean';
                } else if (reason.includes('Completion')) {
                    reason = 'Task Completion';
                }
                acc[reason] = (acc[reason] || 0) + 1;
                return acc;
            }, {});
            return {
                labels: Object.keys(counts),
                data: Object.values(counts)
            };
        }

        function getTimeline() {
            const counts = cleaningData.reduce((acc, entry) => {
                const date = new Date(entry.date).toLocaleDateString('en-CA'); // YYYY-MM-DD for sorting
                acc[date] = (acc[date] || 0) + 1;
                return acc;
            }, {});
            const sorted = Object.entries(counts).sort((a, b) => a[0].localeCompare(b[0]));
            return {
                labels: sorted.map(item => new Date(item[0]).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                data: sorted.map(item => item[1])
            };
        }

        // --- CHART RENDERING ---

        function renderChart(view) {
            const ctx = document.getElementById('cleaningChart').getContext('2d');
            const chartTitle = document.getElementById('chartTitle');
            const chartSubtitle = document.getElementById('chartSubtitle');

            if (myChart) {
                myChart.destroy();
            }

            let chartData, chartType, options;
            const commonOptions = {
                maintainAspectRatio: false,
                responsive: true,
                plugins: {
                    legend: {
                        labels: {
                            color: '#d1d5db' // text-gray-300
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1f2937', // bg-gray-800
                        titleColor: '#ffffff',
                        bodyColor: '#d1d5db',
                        borderColor: '#4b5563', // border-gray-600
                        borderWidth: 1
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: '#374151' }, // border-gray-700
                        ticks: { 
                            color: '#9ca3af', // text-gray-400
                            precision: 0
                        }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { color: '#9ca3af' } // text-gray-400
                    }
                }
            };
            
            const colors = {
                blue: 'rgba(59, 130, 246, 0.7)',
                indigo: 'rgba(99, 102, 241, 0.7)',
                purple: 'rgba(139, 92, 246, 0.7)',
                pink: 'rgba(236, 72, 153, 0.7)',
                orange: 'rgba(249, 115, 22, 0.7)',
                green: 'rgba(34, 197, 94, 0.7)',
                teal: 'rgba(20, 184, 166, 0.7)',
            };
            const colorPalette = Object.values(colors);

            switch (view) {
                case 'byReason':
                    chartData = getVisitsByReason();
                    chartType = 'doughnut';
                    chartTitle.textContent = 'Entries by Reason';
                    chartSubtitle.textContent = 'Highlights why rooms were entered multiple times.';
                    options = {
                        maintainAspectRatio: false,
                        responsive: true,
                         plugins: {
                            legend: {
                                position: 'right',
                                labels: { color: '#d1d5db' }
                            },
                             tooltip: commonOptions.plugins.tooltip
                        }
                    };
                    break;
                case 'timeline':
                    chartData = getTimeline();
                    chartType = 'line';
                    chartTitle.textContent = 'Timeline of Room Entries';
                    chartSubtitle.textContent = 'Shows the number of cleaning entries each day.';
                    options = { ...commonOptions,
                        elements: {
                            line: {
                                tension: 0.2,
                                borderColor: colors.blue,
                                borderWidth: 3
                            },
                            point: {
                                backgroundColor: colors.blue,
                                radius: 5,
                                hoverRadius: 7
                            }
                        }
                    };
                    break;
                case 'perRoom':
                default:
                    chartData = getVisitsPerRoom();
                    chartType = 'bar';
                    chartTitle.textContent = 'Visits Per Room';
                    chartSubtitle.textContent = 'Shows how many times each room was entered for cleaning tasks.';
                    options = { ...commonOptions };
                    options.scales.x.ticks.autoSkip = false;
                    options.scales.x.ticks.maxRotation = 45;
                    options.scales.x.ticks.minRotation = 45;
                    break;
            }

            myChart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: chartType === 'doughnut' ? 'Entries' : 'Number of Entries',
                        data: chartData.data,
                        backgroundColor: chartType === 'line' ? 'transparent' : colorPalette,
                        borderColor: chartType === 'doughnut' ? '#1f2937' : colorPalette,
                        borderWidth: chartType === 'doughnut' ? 3 : 1
                    }]
                },
                options: options
            });
        }
        
        // --- TABLE RENDERING ---
        
        function getRoomSummary() {
            const summary = cleaningData.reduce((acc, entry) => {
                if (!acc[entry.room]) {
                    acc[entry.room] = { dates: [] };
                }
                acc[entry.room].dates.push(entry.date);
                return acc;
            }, {});

            const sortedRooms = Object.keys(summary).sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));

            const formattedSummary = sortedRooms.map(room => {
                const formattedDates = summary[room].dates
                    .sort((a, b) => new Date(a) - new Date(b))
                    .map(date => new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                return {
                    room: room,
                    visits: summary[room].dates.length,
                    dates: formattedDates.join(', ')
                };
            });
            return formattedSummary;
        }


        function renderTable() {
            const tableBody = document.getElementById('logTableBody');
            tableBody.innerHTML = ''; // Clear existing rows

            const summaryData = getRoomSummary();

            if (summaryData.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="3" class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 text-center">No entries found.</td>`;
                tableBody.appendChild(row);
                return;
            }

            summaryData.forEach(roomSummary => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-700/50 transition-colors duration-150';
                const visitCountColor = roomSummary.visits > 2 ? 'text-red-400' : 'text-gray-300';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">Room ${roomSummary.room}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-center font-semibold ${visitCountColor}">${roomSummary.visits}</td>
                    <td class="px-6 py-4 text-sm text-gray-400">${roomSummary.dates}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // --- TIMELINE RENDERING ---
        function renderTimeline() {
            const timelineContainer = document.getElementById('timelineContainer');
            timelineContainer.innerHTML = ''; // Clear existing content

            timelineEvents.forEach(event => {
                const eventElement = document.createElement('div');
                eventElement.className = 'bg-gray-900/50 border border-gray-700 p-4 rounded-lg';
                eventElement.innerHTML = `
                    <p class="text-sm font-semibold text-blue-400 mb-1">${event.date}</p>
                    <h4 class="font-bold text-white">${event.title}</h4>
                    <div class="text-gray-400 mt-2 text-sm">${event.description}</div>
                    <div class="mt-3 pt-3 border-t border-gray-700">
                         <p class="text-xs text-gray-500"><span class="font-semibold">Impact:</span> ${event.impact}</p>
                    </div>
                `;
                timelineContainer.appendChild(eventElement);
            });
        }
        
        // --- UPDATE METRICS ---
        function updateMetrics() {
            const roomData = getVisitsPerRoom();
            const uniqueRooms = new Set(cleaningData.map(d => d.room));
            
            document.getElementById('totalRooms').textContent = uniqueRooms.size;
            document.getElementById('totalEntries').textContent = cleaningData.length;
            
            const avg = (cleaningData.length / uniqueRooms.size).toFixed(1);
            document.getElementById('avgVisits').textContent = avg;

            if(roomData.data.length > 0) {
                const maxVisits = Math.max(...roomData.data);
                const mostVisitedRoom = roomData.labels[roomData.data.indexOf(maxVisits)];
                document.getElementById('mostVisited').textContent = mostVisitedRoom.replace('Room ','');
            }
        }

        // --- INITIALIZATION & EVENT LISTENERS ---

        document.addEventListener('DOMContentLoaded', () => {
            const viewSelector = document.getElementById('viewSelector');
            
            // Initial render
            renderChart(viewSelector.value);
            updateMetrics();
            renderTable();
            renderTimeline();

            // Event listener for chart view dropdown
            viewSelector.addEventListener('change', (event) => {
                renderChart(event.target.value);
            });
        });

    </script>
</body>
</html>

